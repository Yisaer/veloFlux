name: Perf Daily Wide MQTT

on:
  pull_request: {}
  workflow_dispatch: {}

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always

jobs:
  perf-daily:
    name: Wide MQTT Perf
    runs-on: ubuntu-latest
    services:
      emqx:
        image: emqx/emqx:5.6.1
        ports:
          - 1883:1883
        env:
          EMQX_ALLOW_ANONYMOUS: "true"
          EMQX_LISTENER__TCP__DEFAULT__BIND: "0.0.0.0:1883"
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Build veloflux (system allocator)
        run: |
          set -euo pipefail
          mkdir -p tmp/perf_daily_ci/bin
          cargo build --release --no-default-features --features metrics,allocator-system
          cp target/release/veloflux tmp/perf_daily_ci/bin/veloflux-system

      - name: Run perf scenario (system allocator + THP disabled + GLIBC_TUNABLES)
        env:
          PERF_DURATION_SECS: "120"
        run: |
          set -euo pipefail
          trap 'set +e; for p in tmp/perf_daily_ci/*/veloflux.pid; do if [ -f "$p" ]; then kill "$(cat "$p")" 2>/dev/null || true; fi; done' EXIT

          start_veloflux() {
            local bin="$1"
            local data_dir="$2"
            local log_path="$3"
            local pid_path="$4"

            mkdir -p "$(dirname "$log_path")"
            rm -f "$pid_path"

            # Tighten RSS behavior for system allocator builds.
            GLIBC_TUNABLES="glibc.malloc.arena_max=2:glibc.malloc.tcache_count=0:glibc.malloc.trim_threshold=524288" \
            "$bin" --config etc/config.example.yaml --data-dir "$data_dir" > "$log_path" 2>&1 &

            echo $! > "$pid_path"
          }

          stop_veloflux() {
            local pid_path="$1"
            set +e
            if [ -f "$pid_path" ]; then
              local pid
              pid="$(cat "$pid_path")"
              kill "$pid" 2>/dev/null || true

              # Ensure the process exits (ports/file locks released) before the next case starts.
              for _ in $(seq 1 60); do
                if ! kill -0 "$pid" 2>/dev/null; then
                  break
                fi
                sleep 1
              done

              if kill -0 "$pid" 2>/dev/null; then
                kill -9 "$pid" 2>/dev/null || true
              fi
              rm -f "$pid_path"
            fi
            set -e
          }

          dump_mem() {
            local pid="$1"
            local variant="$2"
            local phase="$3"
            local out_path="$4"

            mkdir -p "$(dirname "$out_path")"
            {
              echo "==== memdump variant=${variant} phase=${phase} pid=${pid} ===="
              ps -o pid,rss,vsz,cmd -p "$pid" 2>/dev/null || true
              if [ -r "/proc/${pid}/smaps_rollup" ]; then
                cat "/proc/${pid}/smaps_rollup" || true
              elif command -v pmap >/dev/null 2>&1; then
                pmap -x "$pid" || true
              else
                echo "memdump: /proc/<pid>/smaps_rollup not readable and pmap not available"
              fi
              echo
            } | tee -a "$out_path"
          }

          run_case() {
            local variant="$1"
            local sql_mode="$2"
            local out_dir="$3"
            local pipeline_id="$4"
            local title="$5"
            local log_path="$6"

            PYTHONPYCACHEPREFIX=tmp/pycache \
            python3 tests/perf_daily/perf_daily.py \
              --force \
              --base-url http://127.0.0.1:8080 \
              --metrics-url http://127.0.0.1:9898/metrics \
              --broker-url tcp://127.0.0.1:1883 \
              --topic /perf/daily \
              --qos 1 \
              --columns 15000 \
              --sql-mode "$sql_mode" \
              --pipeline-id "$pipeline_id" \
              --cases 20 \
              --str-len 10 \
              --duration-secs "${PERF_DURATION_SECS}" \
              --rate 50 \
              --scrape-interval-ms 15000 \
              --out-dir "$out_dir" \
              run || { echo "veloflux log (last 200 lines):"; tail -n 200 "$log_path" || true; exit 1; }

            PYTHONPYCACHEPREFIX=tmp/pycache \
            python3 tests/perf_daily/perf_daily_report.py \
              --result-json "$out_dir/result.json" \
              --out-html "$out_dir/report.html" \
              --summary-path "${GITHUB_STEP_SUMMARY}" \
              --title "$title"
          }

          run_variant() {
            local variant="$1"
            local bin="$2"

            local base="tmp/perf_daily_ci/${variant}"
            local data_dir="${base}/data"
            local log_path="${base}/veloflux.log"
            local pid_path="${base}/veloflux.pid"
            local mem_path="${base}/memdump.txt"

            # Explicit columns
            start_veloflux "$bin" "$data_dir" "$log_path" "$pid_path"
            dump_mem "$(cat "$pid_path")" "$variant" "pre-explicit" "$mem_path"
            run_case "$variant" "explicit" "${base}/out_explicit" "perf_daily_${variant}_pipeline_explicit" "Perf Daily Wide MQTT - ${variant} - explicit (2m) (${{ github.sha }})" "$log_path"
            dump_mem "$(cat "$pid_path")" "$variant" "post-explicit" "$mem_path"
            stop_veloflux "$pid_path"

            # Select *
            start_veloflux "$bin" "$data_dir" "$log_path" "$pid_path"
            dump_mem "$(cat "$pid_path")" "$variant" "pre-star" "$mem_path"
            run_case "$variant" "star" "${base}/out_star" "perf_daily_${variant}_pipeline_star" "Perf Daily Wide MQTT - ${variant} - select * (2m) (${{ github.sha }})" "$log_path"
            dump_mem "$(cat "$pid_path")" "$variant" "post-star" "$mem_path"
            stop_veloflux "$pid_path"
          }

          run_variant "system" "tmp/perf_daily_ci/bin/veloflux-system"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-daily-wide-mqtt-${{ github.run_id }}
          if-no-files-found: ignore
          path: |
            tmp/perf_daily_ci/**/result.json
            tmp/perf_daily_ci/**/metrics.openmetrics
            tmp/perf_daily_ci/**/report.html
            tmp/perf_daily_ci/**/veloflux.log
            tmp/perf_daily_ci/**/memdump.txt
