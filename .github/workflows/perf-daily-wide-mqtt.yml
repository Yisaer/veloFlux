name: Perf Daily Wide MQTT

on:
  workflow_dispatch: {}

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always

jobs:
  perf-daily:
    name: Wide MQTT Perf
    runs-on: ubuntu-latest
    services:
      emqx:
        image: emqx/emqx:5.6.1
        ports:
          - 1883:1883
        env:
          EMQX_ALLOW_ANONYMOUS: "true"
          EMQX_LISTENER__TCP__DEFAULT__BIND: "0.0.0.0:1883"
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Build veloflux (release)
        run: make release

      - name: Start veloflux
        env:
          # Use the default jemalloc (enabled by default features) with perf-oriented runtime tuning.
          _RJEM_MALLOC_CONF: "background_thread:true,dirty_decay_ms:0,muzzy_decay_ms:0"
        run: |
          set -euo pipefail
          mkdir -p tmp/perf_daily_ci
          target/release/veloflux --config etc/config.example.yaml --data-dir tmp/perf_daily_ci/data > tmp/perf_daily_ci/veloflux.log 2>&1 &
          echo $! > tmp/perf_daily_ci/veloflux.pid

      - name: Run perf scenario (explicit columns)
        env:
          PERF_OUT_DIR: tmp/perf_daily_ci/out_explicit
          PERF_DURATION_SECS: "120"
        run: |
          set -euo pipefail
          PYTHONPYCACHEPREFIX=tmp/pycache \
          python3 tests/perf_daily/perf_daily.py \
            --force \
            --base-url http://127.0.0.1:8080 \
            --metrics-url http://127.0.0.1:9898/metrics \
            --broker-url tcp://127.0.0.1:1883 \
            --topic /perf/daily \
            --qos 1 \
            --columns 15000 \
            --sql-mode explicit \
            --pipeline-id perf_daily_pipeline_explicit \
            --cases 20 \
            --str-len 10 \
            --duration-secs "${PERF_DURATION_SECS}" \
            --rate 50 \
            --scrape-interval-ms 15000 \
            --out-dir "${PERF_OUT_DIR}" \
            run

      - name: Render report (explicit columns)
        env:
          PERF_OUT_DIR: tmp/perf_daily_ci/out_explicit
        run: |
          set -euo pipefail
          PYTHONPYCACHEPREFIX=tmp/pycache \
          python3 tests/perf_daily/perf_daily_report.py \
            --result-json "${PERF_OUT_DIR}/result.json" \
            --out-html "${PERF_OUT_DIR}/report.html" \
            --summary-path "${GITHUB_STEP_SUMMARY}" \
            --title "Perf Daily Wide MQTT - explicit (2m) (${{ github.sha }})"

      - name: Stop veloflux (after explicit)
        if: always()
        run: |
          set +e
          if [ -f tmp/perf_daily_ci/veloflux.pid ]; then
            kill "$(cat tmp/perf_daily_ci/veloflux.pid)" 2>/dev/null || true
          fi

      - name: Start veloflux (for select *)
        env:
          # Use the default jemalloc (enabled by default features) with perf-oriented runtime tuning.
          _RJEM_MALLOC_CONF: "background_thread:true,dirty_decay_ms:0,muzzy_decay_ms:0"
        run: |
          set -euo pipefail
          mkdir -p tmp/perf_daily_ci
          target/release/veloflux --config etc/config.example.yaml --data-dir tmp/perf_daily_ci/data > tmp/perf_daily_ci/veloflux.log 2>&1 &
          echo $! > tmp/perf_daily_ci/veloflux.pid

      - name: Run perf scenario (select *)
        env:
          PERF_OUT_DIR: tmp/perf_daily_ci/out_star
          PERF_DURATION_SECS: "120"
        run: |
          set -euo pipefail
          PYTHONPYCACHEPREFIX=tmp/pycache \
          python3 tests/perf_daily/perf_daily.py \
            --force \
            --base-url http://127.0.0.1:8080 \
            --metrics-url http://127.0.0.1:9898/metrics \
            --broker-url tcp://127.0.0.1:1883 \
            --topic /perf/daily \
            --qos 1 \
            --columns 15000 \
            --sql-mode star \
            --pipeline-id perf_daily_pipeline_star \
            --cases 20 \
            --str-len 10 \
            --duration-secs "${PERF_DURATION_SECS}" \
            --rate 50 \
            --scrape-interval-ms 15000 \
            --out-dir "${PERF_OUT_DIR}" \
            run

      - name: Render report (select *)
        env:
          PERF_OUT_DIR: tmp/perf_daily_ci/out_star
        run: |
          set -euo pipefail
          PYTHONPYCACHEPREFIX=tmp/pycache \
          python3 tests/perf_daily/perf_daily_report.py \
            --result-json "${PERF_OUT_DIR}/result.json" \
            --out-html "${PERF_OUT_DIR}/report.html" \
            --summary-path "${GITHUB_STEP_SUMMARY}" \
            --title "Perf Daily Wide MQTT - select * (2m) (${{ github.sha }})"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: perf-daily-wide-mqtt-${{ github.run_id }}
          if-no-files-found: ignore
          path: |
            tmp/perf_daily_ci/out_explicit/result.json
            tmp/perf_daily_ci/out_explicit/metrics.openmetrics
            tmp/perf_daily_ci/out_explicit/report.html
            tmp/perf_daily_ci/out_star/result.json
            tmp/perf_daily_ci/out_star/metrics.openmetrics
            tmp/perf_daily_ci/out_star/report.html
            tmp/perf_daily_ci/veloflux.log

      - name: Stop veloflux
        if: always()
        run: |
          set +e
          if [ -f tmp/perf_daily_ci/veloflux.pid ]; then
            kill "$(cat tmp/perf_daily_ci/veloflux.pid)" 2>/dev/null || true
          fi
